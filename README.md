# üöÄ Decision Match ‚Äî Pipeline, API, UI & Observability

Sistema de **matching candidato ‚Üî vaga** com pipeline de ML, **API em FastAPI**, **UI em Streamlit** e **observabilidade** (Prometheus + Grafana + Drift/Evidently). Projeto pronto para desenvolvimento local (Windows 11) e para execu√ß√£o via **Docker Compose**.

> üí° **Dica:** este README foi preparado para ser usado como documento de entrega do projeto. Inclu√≠ espa√ßos para **imagens** (Grafana/Drift e UI de upload) ‚Äî basta colocar os arquivos em `scr/imgs/`.

---

## üó∫Ô∏è Arquitetura

- **Pipeline de ML** (TF‚ÄëIDF + modelo linear scikit‚Äëlearn) ‚Üí artefatos versionados em `models/artifacts/`.
- **API (FastAPI)** exp√µe `POST /score`, `POST /rank-candidates`, m√©tricas Prometheus em `/metrics` e health em `/health`.
- **UI (Streamlit)** para testar a API com inputs reais.
- **Drift Service** (FastAPI + Evidently): l√™ `monitoring/requests_log.csv`, compara com `models/artifacts/baseline_features.csv` e publica:
  - M√©tricas em `/metrics` (Prometheus).
  - Relat√≥rios HTML em `monitoring/drift_reports/`.
- **Prometheus** coleta m√©tricas de `api:8000` e `drift:8001`.
- **Grafana** oferece dashboards provisionados por c√≥digo (datasource + painel ‚ÄúDecision Match ‚Äî Observability‚Äù).

üì∏ **Espa√ßo para imagem do monitoramento (Grafana/Drift):**  
> Coloque sua imagem em `scr/imgs/grafana_drift.png` e ela aparecer√° aqui:
  
![Grafana Drift](scr/imgs/grafana_drift.png)

---

## üìÇ Estrutura do reposit√≥rio

```
‚îú‚îÄ docker/                  # Dockerfiles (api, ui, drift)
‚îú‚îÄ monitoring/
‚îÇ  ‚îú‚îÄ grafana/
‚îÇ  ‚îÇ  ‚îú‚îÄ provisioning/
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ datasources/datasource.yml
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ dashboards/dashboards.yml + dm_observability.json
‚îÇ  ‚îÇ  ‚îî‚îÄ ... (dados persistidos do Grafana)
‚îÇ  ‚îú‚îÄ prometheus.yml        # Targets api/drift
‚îÇ  ‚îú‚îÄ drift_reports/        # Relat√≥rios Evidently (gerados em runtime)
‚îÇ  ‚îî‚îÄ requests_log.csv      # Log de tr√°fego (gerado pela API)
‚îú‚îÄ models/
‚îÇ  ‚îî‚îÄ artifacts/            # Artefatos do modelo (baseline, vetores, etc.)
‚îú‚îÄ scripts/                 # *.bat para Windows (setup, test, serve, train, docker)
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ api/                  # FastAPI (main, schemas)
‚îÇ  ‚îú‚îÄ features/             # Limpeza/feature engineering
‚îÇ  ‚îú‚îÄ labeling/             # Mapeamento de targets
‚îÇ  ‚îú‚îÄ monitoring/           # drift_service (Evidently)
‚îÇ  ‚îî‚îÄ ...                   # utils, pipeline, treino, etc.
‚îú‚îÄ ui/                      # Streamlit app
‚îú‚îÄ tests/                   # unit + integration (pytest)
‚îú‚îÄ docker-compose.yml
‚îú‚îÄ pyproject.toml | requirements.txt
‚îî‚îÄ README.md
```

> ‚ÑπÔ∏è As pastas `monitoring/` e `models/artifacts/` s√£o montadas como volumes pelo Docker Compose.

---

## ‚úÖ Pr√©‚Äërequisitos

- **Windows 11** + **Docker Desktop** (WSL2) + **Git** + **VS Code**.
- Python **3.11** (opcional para rodar local sem Docker).

---

## üíª Instala√ß√£o e desenvolvimento local (Windows 11 + VS Code)

```bat
:: 1) criar ambiente e instalar deps
scripts\setup_venv.bat

:: 2) (opcional) ativar venv manualmente
call .venv\Scripts\activate
```

---

## üß† Treino do modelo

Gera artefatos em `models/artifacts/` e **baseline** para drift (`baseline_features.csv`).

```bat
scripts\train.bat
```

Ao final, s√£o exibidas m√©tricas de valida√ß√£o cruzada (ex.: **NDCG@5**, **F1_mean**, **ROC_AUC_mean**) e √© definido um `threshold_topk` (utilizado pela API).

---

## üß™ Testes e cobertura

Executa **pytest** + **pytest-cov** e valida o mapeamento de targets e limpeza de texto, al√©m de integrar a API.

```bat
scripts\test.bat
```

Exemplo de cobertura obtida no projeto: **96%** (com `src/api/main.py` chegando a ~94%).

---

## ‚ñ∂Ô∏è Subir a API e a UI localmente

```bat
:: API (FastAPI)
scripts\serve.bat
:: abre: http://localhost:8000/docs  e  http://localhost:8000/health

:: UI (Streamlit) ‚Äî se houver script espec√≠fico, usar:
:: streamlit run ui/app.py --server.port=8501 --server.address=0.0.0.0
```

üì∏ **Espa√ßo para imagem da UI (upload no Streamlit):**  
> Coloque sua imagem em `scr/imgs/streamlit_upload.png` e ela aparecer√° aqui:

![Streamlit Upload](scr/imgs/streamlit_upload.png)

---

## üê≥ Docker: build e subida dos servi√ßos

Build das imagens e subida dos containers (API, UI, Drift, Prometheus, Grafana):

```bat
docker compose build
docker compose up -d
docker compose ps
```

> Para subir servi√ßos isolados: `docker compose up -d api ui`, etc.  
> Para derrubar tudo: `docker compose down`.

**Rede**: `dm_net` conecta todos os servi√ßos.  
**Volumes**:
- `./models/artifacts:/app/models/artifacts:ro`
- `./monitoring:/monitoring`

---

## üåê URLs e endpoints

**UI (Streamlit):**  
- `http://localhost:8501` ‚Äî interface para interagir com a API.

**API (FastAPI):**  
- `http://localhost:8000` ‚Äî raiz  
- `http://localhost:8000/health` ‚Äî healthcheck (modelo, threshold, etc.)  
- `http://localhost:8000/docs` ‚Äî Swagger UI  
- `http://localhost:8000/metrics` ‚Äî m√©tricas Prometheus  
- `POST http://localhost:8000/score` ‚Äî score de um candidato  
- `POST http://localhost:8000/score-batch` ‚Äî score em lote  
- `POST http://localhost:8000/rank-candidates` ‚Äî ranking

**Drift Service:**  
- `http://localhost:8001/health` ‚Äî status (baseline/log)  
- `http://localhost:8001/metrics` ‚Äî m√©tricas Prometheus (p-value, flag)  
- Relat√≥rios Evidently: `monitoring/drift_reports/` (gerados em runtime)

**Prometheus:**  
- `http://localhost:9090` ‚Äî console  
- `http://localhost:9090/targets` ‚Äî alvos de scrape (api/drift)

**Grafana:**  
- `http://localhost:3000` ‚Äî dashboards (login **admin/admin**)  
- Dashboard provisionado: **Decision Match ‚Äî Observability** (pasta *Decision Match*)

---

## üìà Observabilidade e Drift

- A **API** exp√µe contadores/histogramas: **requests total por endpoint/status** e **lat√™ncia** (*histogram buckets*).
- O **Drift Service** roda a cada **60s**:
  1. Carrega baseline (`models/artifacts/baseline_features.csv`).
  2. L√™ `monitoring/requests_log.csv` gerado pelas rotas da API.
  3. Executa Evidently (**DataDriftPreset**), exporta:
     - **M√©tricas**: `dm_drift_p_value{feature}`, `dm_drift_detected{feature}`.
     - **Relat√≥rio HTML**: `monitoring/drift_reports/drift_<timestamp>.html`.

> Para ver dados no painel, gere tr√°fego (UI ou `POST /score`) e aguarde ~1‚Äì2 min.

### Popular rapidamente (PowerShell)
```powershell
for ($i=0; $i -lt 250; $i++) {
  $body = @{
    cv_pt="Dev Python com FastAPI e Docker $i"
    titulo_vaga="Backend Python"
    principais_atividades="APIs REST"
    competencias="Python; FastAPI; Docker; SQL"
    observacoes=""
  } | ConvertTo-Json
  Invoke-RestMethod -Method POST -Uri http://localhost:8000/score -Body $body -ContentType "application/json" | Out-Null
}
```

---

## ‚öôÔ∏è Provisionamento autom√°tico do Grafana (as‚Äëcode)

Arquivos em `monitoring/grafana/provisioning/`:

- **Datasource**: Prometheus (`url: http://prometheus:9090`, `uid: PROM`).  
- **Dashboards**: provider aponta para `/etc/grafana/provisioning/dashboards` e carrega `dm_observability.json`.

Reaplicar rapidamente:
```bat
docker compose restart grafana
docker compose logs -f grafana
```

---

## üîß Vari√°veis de ambiente

| Nome                | Servi√ßo | Default | Descri√ß√£o |
|---------------------|--------:|:------:|-----------|
| `THRESHOLD_TOPK`    | API     | `0.5`  | Limite m√≠nimo de score para considerar um candidato |
| `TARGET_K`          | API     | `5`    | Top‚ÄëK retornado pelo ranking |
| `MONITORING_DIR`    | API/Drift | `/monitoring` | Pasta compartilhada para logs/relat√≥rios |
| `DRIFT_REPORTS_DIR` | Drift   | (opcional) | Se definido, sobrescreve o diret√≥rio de relat√≥rios (padr√£o `MONITORING_DIR/drift_reports`) |

---

## ü©π Troubleshooting (Windows/Docker/Grafana)

- **Docker API/Context (Windows):**
  ```powershell
  docker context ls
  docker context use desktop-linux
  ```
- **`drift` reiniciando com `Read-only file system`:** grave relat√≥rios em `/monitoring/drift_reports` (n√£o em `/app/models/artifacts`).  
- **Prometheus `no such host drift`:** todos os servi√ßos na rede `dm_net` + `docker compose up -d`.  
- **Grafana n√£o carrega dashboard JSON:** salve **sem BOM** (UTF‚Äë8). Reinicie o Grafana.  
- **Dashboards ‚ÄúNo data‚Äù:** selecione **All** nas vari√°veis, ajuste o time range (ex.: *Last 1 hour*) e gere tr√°fego.

---

## üéØ Boas pr√°ticas e pr√≥ximos passos

- **SLOs**: defina metas (ex.: *p95 ‚â§ 1s*, *error rate < 1%*) e **alertas** no Grafana (p95, erro, drift).  
- **Dados/Privacidade**: evite logar PII; use proxies de m√©tricas (comprimentos, scores).  
- **MLOps**: versionar artefatos, automatizar re‚Äëtreino quando drift for detectado.  
- **CI/CD**: pipelines com lint, testes, build de imagens e deploy versionado.

---

## üìÑ Licen√ßa

Projeto acad√™mico/educacional. Ajuste a licen√ßa conforme pol√≠tica da equipe/organiza√ß√£o.
